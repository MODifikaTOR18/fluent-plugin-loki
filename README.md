# fluent-plugin-loki

[Fluentd](https://fluentd.org/) output plugin to [Grafana Loki](https://github.com/grafana/loki).

- Can be used to ship docker logs to Loki (using [Fluentd docker logging driver](https://docs.docker.com/config/containers/logging/fluentd/))
- Enable easier transtion to Loki - an alternative to Loki's Promtail 

**Under devlopment!!**

## Configuration
sample configuration:
```
<match *>
  @type http
  endpoint_url    http://127.0.0.1:3100
  labels          {"env":"prod","farm":"a"} # default: nil
  tenant          abcd           # default: nil
  rate_limit_msec 100            # default: 0 = no rate limiting
  raise_on_error  false          # default: true
  authentication  basic          # default: none
  username        alice          # default: ''
  password        bobpop         # default: '', secret: true
  buffered        true           # default: false. Switch non-buffered/buffered mode
  cacert_file     /etc/ssl/endpoint1.cert # default: ''
  token           tokent         # default: ''
  custom_headers  {"token":"arbitrary"} # default: nil
</match>
```
- **endpoint_url** - Loki's endpoint
- **tenant** - Loki tenant id
- **labels** - Labels for filtering in Grafana (currently they are static)

(generated by running: ```fluent-plugin-config-format output loki -p lib/fluent/plugin```)

## Development (using Docker)
- Set up Loki and Grafana (can be done by running their [docker-compose](https://github.com/grafana/loki/blob/master/production/docker-compose.yaml))
- Add loki data source to grafana
- Run Fluentd container with volume mapping to the dummy configuration and to the plugin:
```bash
docker run -d \
  -p 9880:9880 \
  -v $(pwd)/development/conf:/fluentd/etc \
  -v $(pwd)/lib/fluent/plugin:/etc/fluent/plugin -e FLUENTD_CONF=fluentd.conf \
  fluent/fluentd
```
- Execute to send log: ```curl -X POST -d 'json={"foo":"baz"}' http://localhost:9880```


## Copyright

* Copyright(c) 2018- Edan Shahmoon
* License
  * Apache License, Version 2.0

Heavily based on [fluent-plugin-out-http](https://github.com/fluent-plugins-nursery/fluent-plugin-out-http)
